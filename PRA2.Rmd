---
title: 'Tipologia i cicle de vida de les dades: PRA2'
author: "Autors: Laura Guerra i Àlex Tort"
date: "Desembre 2023"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

------------------------------------------------------------------------

# Pràctica 2 - Tipologia i cicle de vida de les dades

------------------------------------------------------------------------

## Descripció del dataset

> Durant els últims anys el mercat immobiliari andorrà ha observat un augment notable en la demanda d'habitatges, tant de compra com de lloguer, degut al creixent interès de residents estrangers pel país.
> La demanda és tal que s'ha superat l'oferta disponible, donat lloc a un mercat immobiliari molt competitiu amb preus constantment a l'alça; convertint l'accés a l'habitatge en un problema de dimensions cada vegada majors.
> Moltes persones, tant de nacionalitat andorrana com potencials nous residents, s'han vist obligats a buscar alternatives que sovint impliquen buscar un habitatge a localitats properes però fora del país, com per exemple La Seu d'Urgell.
>
> Per aquest motiu hem considerat que disposar de dades detallades del mercat immobiliari andorrà, tant de venta com de lloguer, pot resultar molt útil per determinar, entre d'altres, els factors que influeixen en els preus de les propietats, la distribució geogràfica d'aquestes, quines parròquies experimenten un major creixement i quines han experimentat un major increment en els preus\...
>
> Un dels primers objectius de l'anàlisi de les dades obtingudes és determinar la situació actual de la oferta i la demanda, i per tant, de la disponibilitat d'immobles.
> A part d'un primer estudi generalitzat, també es pot determinar la distribució d'oferta per parròquies, per tal d'observar si la situació és similar a totes les parròquies o hi ha més oferta i/o demanda en funció de la localització dels immobles.
> L'estudi de la distribució de la oferta també es pot realitzar en funció de la tipologia de la transacció, és a dir, si la propietat és de lloguer o està en venta.
> Aquest estudi pot complementar-se tenint en compte les estadístiques publicades pel Departament d'Estadística d'Andorra sobre el nombre d'edificis per parròquia i tipus o la població registrada per parròquia.
>
> Una altra dimensió rellevant que volem explorar és la distribució de preus en funció de la ubicació de l'immoble, així com de les característiques d'aquest (nombre d'habitacions, superfície, garatge\...), determinant quin pes pot arribar a tenir cada característica a l'hora d'establir els preus.
> Un cop s'hagi obtingut aquesta informació, es pot comparar amb els ingressos mitjans o medians per unitat de consum i determinar així quin percentatge d'aquests pot representar el lloguer d'un immoble.
>
> Per dur a terme aquest estudi s'ha recopilat un conjunt de dades de propietats per zona geogràfica, tipus d'habitatge i altres característiques específiques del portal immobiliari pisos.ad a data de 9 de novembre.
> El conjunt conté 3442 registres, per als quals es recullen 11 variables:
>
> \- Price: preu establert a l'anunci.
> En cas de tractar-se d'una propietat de lloguer, el preu correspon al preu mensual d'aquesta.
> El format actual de la variable és el valor en format text, amb punts als milers i en €.
>
> \- Area: superfície de la propietat, em m2.
> De nou, actualment es tracta d'una variable textual composta pel valor de la superfície de la propietat i les unitats corresponents.
>
> \- Bedrooms: nombre d'habitacions de la propietat.
> En cas de no tractar-se d'un immoble, aquesta variable té com a valor "0 Habitacions".
>
> \- Parking: variable categòrica binària que indica si la propietat disposa de garatge.
> Els seus valors són "Inclòs" i "No Inclòs".
>
> \- Features: llista de característiques de la propietat.
>
> \- Agency: nom de l'agència immobiliària que ha publicat l'anunci.
>
> \- Id: identificador numèric únic de l'anunci, que es correspon amb la referència del portal.
>
> \- Type: tipologia de la transacció anunciada.
> Els possibles valors de la variable són "venda" i
>
> "lloguer".
>
> \- Zone: parròquia on es troba ubicada la propietat.
> Els possibles valors són "ordino", "canillo",
>
> "encamp", "andorra-la-vella", "sant-julia-de-loria", "escaldes-engordany" i "la-massana".
>
> \- URL: enllaç de l'anunci.
>
> \- Timestamp: data i hora de l'extracció.
> Degut a l'elevada demanda, és possible que part dels anuncis (sobretot els de lloguer) deixin d'estar publicats al portal al cap d'uns dies i per tant no es pugui accedir de nou a la informació.
> Per aquest motiu s'ha considerat rellevant indicar el període al qual pertanyen les dades.
>
> El conjunt de dades pot trobar-se a <https://doi.org/10.5281/zenodo.10112197>
>
> A part, es realitzarà un procés d'integració per addicionar les dades necessàries provinents del Departament d'Estadística d'Andorra.

## Integració i selecció

> Per tal de poder donar resposta a les qüestions plantejades anteriorment, i en concret, per tal de determinar la proporció entre l'oferta i el nombre total d'habitatges així com entre el preu dels lloguers i els ingressos medians de la població, es recopilen i s'integren les dades necessàries més recents publicades pel Departament d'Estadística d'Andorra.

```{r message=FALSE, warning=FALSE}

install.packages("jsonlite",repos='http://cran.us.r-project.org')
install.packages("dplyr",repos='http://cran.us.r-project.org')

library("jsonlite")
library("dplyr")

 
hab_parroquia_taula <-jsonlite::fromJSON('https://sig.govern.ad/SIGDDE.Public/EstadistiquesDades/Grid_TablaDatosEstadisticos?IdDivisio=2802&DataIniciDades=01%2F01%2F2021%2000%3A00%3A00&DataFiDades=12%2F31%2F2021%2000%3A00%3A00&Publicada=True&Validada=True&Idioma=ca&N2=173&N3=174&DV=2802&Pag=PAG_EstadistiquesDades2802173174&DivTaulaDades_2802_59639_68519-sort=A_Descripcio-asc')

ingressos_medians_taula <-jsonlite::fromJSON('https://sig.govern.ad/SIGDDE.Public/EstadistiquesDades/Grid_TablaDatosEstadisticos?IdDivisio=1500&DataIniciDades=01%2F01%2F2018%2000%3A00%3A00&DataFiDades=12%2F31%2F2020%2000%3A00%3A00&Publicada=True&Validada=True&Idioma=ca&N2=131&N3=132&DV=1500&PublicacionsInici.pageSize=10&PublicacionsInici.page=1&Pag=PAG_EstadistiquesDades1500131132&DivTaulaDades_1500_5093_64590-sort=A_Descripcio-asc')


hab_parroquia_df <- as.data.frame(hab_parroquia_taula$Data)
ingressos_medians_df <- as.data.frame(ingressos_medians_taula$Data)

hab_parroquia_df <- hab_parroquia_df[, c('A_Descripcio', 'A_2021')]
ingressos_medians_df <- ingressos_medians_df[, c('A_Descripcio', 'A_2020')]

hab_parroquia_df <- hab_parroquia_df %>% rename('Informacio' = 'A_Descripcio', 'Valor' = 'A_2021')
ingressos_medians_df <- ingressos_medians_df %>% rename('Informacio' = 'A_Descripcio', 'Valor' = 'A_2020')
```

```{r message=FALSE, warning=FALSE}

preus_propietats_df <- read.csv2(file = url("https://zenodo.org/records/10112197/files/preus_propietats_andorra.csv?download=1"))
```

## Neteja de les dades

> Tenint en compte que l'estudi es centra en vivendes, es descarten tots aquells registres de qualsevol altra classe, és a dir, que tinguin un total de zero habitacions.
> Alhora, també es descarten aquells registres que no tinguin valor per qualsevol variable, exceptuant les variables "Features", per la qual s'imputarà un valor més endavant, o "Agency".

```{r message=FALSE, warning=FALSE}

# Es determinen els registers buits
num_rows_missing <- sum(apply(preus_propietats_df[, !(names(preus_propietats_df) %in% c("Features", "Agency"))], 1, function(row) any(is.na(row))))

print(paste("Registres amb valors buits :", num_rows_missing))

preus_propietats_df <- preus_propietats_df[complete.cases(preus_propietats_df[, !(names(preus_propietats_df) %in% c("Features", "Agency"))]), ]

# Es reconverteix la variable Bedrooms en una variable numèrica i es descarten els valors igual a 0

preus_propietats_df$Bedrooms <- as.integer(gsub(" Habitacions", "", preus_propietats_df$Bedrooms))

preus_propietats_df <- preus_propietats_df[preus_propietats_df$Bedrooms > 0, ]
```

> A continuació, es tracten les variables i s'identifiquen i gestionen els valors extrems:

```{r message=FALSE, warning=FALSE}

install.packages("ggplot2",repos = "http://cran.us.r-project.org")
library(ggplot2)

preus_propietats_df$Price <- gsub(" €", "", preus_propietats_df$Price)
preus_propietats_df$Price <- as.integer(gsub("[^0-9]", "", gsub("\\.", "", preus_propietats_df$Price)))
preus_propietats_df$Area <- as.integer(gsub(" m2", "", preus_propietats_df$Area))

# Eliminem valors nuls que s'hagin pogut generar:
preus_propietats_df <- na.omit(preus_propietats_df)

for (variable in c("Price", "Area", "Bedrooms")) {
  plt <- ggplot(preus_propietats_df, aes(x = Type, y = .data[[variable]], fill = Type)) +
    geom_boxplot() +
    labs(title = paste("Distribució de la variable", variable, "segons lloguer/venda"),
         y = variable) +
    theme_minimal() +
    facet_wrap(~Type, scales = "free_y")

  print(plt)
}

```

> Pel que fa a la variable "Bedrooms", si bé sorprèn que algunes de les propietats arribin a tenir fins a vuit habitacions, no és un valor suficientment elevat com per considerar que es tracta d'un error, i per tant, s'ha optat per no descartar els registres.
> De la mateixa manera, tampoc s'han descartat els registres amb àrees superiors a la resta, exceptuant el valor màxim de les propietats en venda i lloguer, ja que es troben molt per sobre fins i tot dels valors més extrems.
> Pel que fa als preus, només es considera un valor extrem descartable el valor màxim de les propietats en venda.
> Més endavant, en cas que es consideri adient pels diferents anàlisi, es podran realitzar les seleccions corresponents, obviant aquells registres que es consideri que distorsionen excessivament els càlculs.

```{r message=FALSE, warning=FALSE}

preus_propietats_df <- preus_propietats_df %>%
  filter(!(Type == "lloguer" & Area > 1000) & !(Type == "venda" & Area > 3000))

preus_propietats_df <- preus_propietats_df %>%
  filter(!(Type == "venda" & Price > 20000000))
```


## Anàlisi de les dades

> Tal com s'indicava a l'inici de la pràctica, l'objectiu és determinar a grans trets l'estat actual del mercat immobiliàri andorrà.
> Així doncs, s'ha considerat que per obtenir una visió global es poden realitzar els anàlisis següents:
>
> 1.  Determinar l'estat actual de l'oferta a través de la proporció entre el nombre d'habitatges en oferta i el nombre d'habitatges totals per parròquia.
>     Per fer-ho, s'han delimitat dues zones, una considerada com la zona cèntrica, que inclou Andorra la Vella i Escaldees, i una zona no cèntrica, que inclou la resta de les parròquies.
>     Així, es durà a terme un contrast d'hipòtesis per determinar si la proporció a la zona no cèntrica és més elevada.
>
> 2.  Estudiar les distribucions de preus de lloguer i venda de les dues zones definides, i comparar els valors mitjans de les dos grups mitjançant un contrast d'hipòtesi per determinar si el preu a la zona cèntrica és superior.
>
> 3.  Determinar la proporció dels ingressos mensuals medians nets que suposa el lloguer d'un pis en funció de la zona, i si aquesta supera el 35% recomanable.
>
> 4.  Desenvolupar un model de regressió lineal per obtenir el preu òptim d'una vivenda a partir de les característiques d'aquesta (superfície, nombre d'habitacions, pàrquing, zona...
>
> 5.  Estudiar les possibles correlacions entre les diferents característiques de les vivendes
>
> Per a l'anàlisi del mercat immobiliari andorrà, seleccionem grups de dades basats en característiques com la ubicació (cèntric o no cèntric), tipus de transacció (venda o lloguer), i atributs de les propietats (nombre d'habitacions i superfície). Aquesta selecció permetrà comparar diferents paràmetres del mercat, com la diferència en preus i característiques entre de les diferents propietats en venda i lloguer. 
> Abans de procedir als anàlisis, s'estudia la normalitat i homogeneïtat de la variància:

```{r message=FALSE, warning=FALSE}

install.packages("car",repos = "http://cran.us.r-project.org")
library(car)

preus_propietats_df$Centric <- ifelse(preus_propietats_df$Zone %in% c("andorra-la-vella", "escaldes-engordany"), 1, 0)

venda_data <- preus_propietats_df[preus_propietats_df$Type == "venda", ]
lloguer_data <- preus_propietats_df[preus_propietats_df$Type == "lloguer", ]

normality_check <- function(data, variable) {
    shapiro_test <- shapiro.test(data[[variable]])
    print(shapiro_test)
    
    par(mfrow = c(1, 2))  
    
    qqnorm(data[[variable]], main = paste("QQ Plot de", variable))
    qqline(data[[variable]])
    
    hist(data[[variable]], main = paste("Histograma de", variable), xlab = paste("Valor de", variable), col = "lightblue", border = "black")
    
    par(mfrow = c(1, 1))  
}

# Aplicar la funció a les variables per a cada subconjunt de dades
for (variable in c("Price", "Area", "Bedrooms")) {
    cat("\nShapiro-Wilk Test per la variable", variable, "en propietats en venda:\n")
    normality_check(venda_data, variable)

    cat("\nShapiro-Wilk Test per a la variable", variable, "en propietats en lloguer:\n")
    normality_check(lloguer_data, variable)
}

```
> Els resultats dels tests de Shapiro-Wilk indiquen clarament que les distribucions de les variables 'Price', 'Area' i 'Bedrooms', tant per a propietats en venda com en lloguer, no segueixen una distribució normal, ja que els valors p són extremadament baixos en tots els casos (menors de 0.05). Això implica que per aquestes variables, les dades es desvien significativament d'una distribució normal.
>
> A continuació farem una comprovació de la igualtat de variàncies entre les propietats cèntriques i no centriques. En aquest cas com les dades no compleixen la condició de normalitat, utilitzarem el test de Fligner-Killeen.

```{r message=FALSE, warning=FALSE}
fligner_test_per_tipus <- function(variable) {
  cat("Fligner-Killeen Test per la variable", variable, "en propietats en venda:\n")
  print(fligner.test(venda_data[[variable]] ~ venda_data$Centric))

  cat("Fligner-Killeen Test per la variable", variable, "en propietats en lloguer:\n")
  print(fligner.test(lloguer_data[[variable]] ~ lloguer_data$Centric))
}

for (variable in c("Price", "Area", "Bedrooms")) {
  fligner_test_per_tipus(variable)
}

```
>Els resultats del test de Fligner-Killeen mostren diferents patrons en la variabilitat de les dades entre les propietats en venda i en lloguer, així com entre zones cèntriques i no cèntriques:
>
>-  Preu (Price) en Venda: Hi ha una variància significativament diferent entre zones (p-value = 3.733e-06), indicant que el preu varia més d'una zona a l'altra.
>-  Preu (Price) en Lloguer: No es troben diferències significatives (p-value = 0.1181), suggerint una major uniformitat en els preus de lloguer independentment de la zona.
>-  Àrea (Area) en Venda i Lloguer: Les variàncies no mostren diferències significatives (p-values = 0.1313 i 0.8488, respectivament), indicant una certa consistència en la mida de les propietats independentment de la zona.
>-  Habitacions (Bedrooms) en Venda: Hi ha una diferència significativa en la variància (p-value = 1.169e-11), mostrant una major variabilitat en el nombre d'habitacions entre zones.
>-  Habitacions (Bedrooms) en Lloguer: Sense diferències significatives (p-value = 0.1834), indicant una uniformitat en la distribució del nombre d'habitacions en lloguer entre zones.

```{r message=FALSE, warning=FALSE}
if (!require("corrplot")) {
  install.packages("corrplot")
  library(corrplot)
}

correlation_matrix <- cor(venda_data[, c("Price", "Area", "Bedrooms", "Centric")], method = "spearman")
corrplot(correlation_matrix, method = "color", addCoef.col = "white")
```

> Els resultats de la correlació de Spearman en el pisos en venda mostren una forta associació entre 'Price' i 'Area' (0.917), indicant que a major àrea de la propietat, major és el preu, en general. Una associació similar es troba entre 'Price' i 'Bedrooms' (0.812), suggerint que propietats amb més habitacions tendeixen a tenir preus més alts. La correlació entre 'Price' i 'Centric' (0.320) és positiva però més moderada, indicant que hi ha una tendència a preus més alts en zones cèntriques, però no és tan forta com les relacions amb l'àrea o el nombre d'habitacions. 
>
> Per altra banda, en els pisos de lloguer trobem aquesta casuística:

```{r message=FALSE, warning=FALSE}
correlation_matrix <- cor(lloguer_data[, c("Price", "Area", "Bedrooms", "Centric")], method = "spearman")
corrplot(correlation_matrix, method = "color", addCoef.col = "white")
```

> En el cas dels pisos en lloguer els resultats són similars als de pisos en venda. Els resultats de la correlació de Spearman mostren una relació forta entre 'Price' i 'Area' (0.755), indicant que els pisos més grans tendeixen a tenir lloguers més alts, cal remarcar però que aquesta correlació no és tan forta com en el cas dels pisos en venda. La correlació entre 'Price' i 'Bedrooms' (0.600) és també positiva, suggerint que propietats amb més habitacions generalment tenen lloguers més alts. La correlació entre 'Price' i 'Centric' (0.308) és positiva però més baixa, indicant una tendència a lloguers més alts en zones cèntriques, però aquesta tendència no és tan forta com la relació amb l'àrea o el nombre d'habitacions.

